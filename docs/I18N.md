# Internationalization (i18n)

This document describes the internationalization setup for the permit-school project, including locale configuration, message catalogs, and how to add new languages.

## Overview

The project uses `next-intl` for internationalization, providing:

- **Locale routing**: URLs include locale prefix (e.g., `/en/courses`, `/es/courses`)
- **Message catalogs**: JSON files for each supported language
- **Server and client i18n**: Consistent internationalization across the application
- **Type-safe translations**: TypeScript support for translation keys

## Supported Locales

Currently supported locales:

- **English (`en`)**: Default locale
- **Spanish (`es`)**: Secondary locale

## Configuration

### Locale Configuration

Locale settings are defined in `web/i18n/request.ts`:

```typescript
export const locales = ["en", "es"] as const;
export const defaultLocale = "en" as const;
export const localePrefix = "always"; // Always include locale in URL
```

### Middleware Configuration

The i18n middleware is configured in `web/middleware.ts`:

```typescript
import createMiddleware from "next-intl/middleware";
import { locales, defaultLocale, localePrefix } from "./i18n/request";

export default createMiddleware({
  locales,
  defaultLocale,
  localePrefix,
  // Skip static assets and API routes
  pathnames: {
    "/": "/",
    "/courses": "/courses",
    // ... other pathnames
  },
});

export const config = {
  matcher: [
    // Skip static assets and API routes
    "/((?!api|_next|_vercel|.*\\..*).*)",
  ],
};
```

## Message Catalogs

### Structure

Message catalogs are stored in `web/messages/`:

```
web/messages/
├── en.json          # English messages
├── es.json          # Spanish messages
└── index.ts         # Type definitions
```

### Message Format

Messages are organized by feature/component:

```json
{
  "common": {
    "loading": "Loading...",
    "error": "An error occurred",
    "save": "Save",
    "cancel": "Cancel"
  },
  "auth": {
    "signIn": "Sign In",
    "signUp": "Sign Up",
    "email": "Email",
    "password": "Password"
  },
  "navigation": {
    "home": "Home",
    "courses": "Courses",
    "profile": "Profile",
    "billing": "Billing"
  }
}
```

### Type Safety

Message types are generated from the JSON files:

```typescript
// web/messages/index.ts
import { getRequestConfig } from "next-intl/server";
import { locales } from "../i18n/request";

export default getRequestConfig(async ({ locale }) => ({
  messages: (await import(`./${locale}.json`)).default,
}));
```

## Usage

### Server Components

Use the `useTranslations` hook in server components:

```typescript
import { useTranslations } from 'next-intl';

export default function CourseList() {
  const t = useTranslations('courses');

  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('description')}</p>
    </div>
  );
}
```

### Client Components

Use the `useTranslations` hook in client components:

```typescript
'use client';

import { useTranslations } from 'next-intl';

export default function LanguageSwitcher() {
  const t = useTranslations('common');

  return (
    <button>
      {t('switchLanguage')}
    </button>
  );
}
```

### API Routes

Use the `getTranslations` function in API routes:

```typescript
import { getTranslations } from "next-intl/server";

export async function GET(request: Request) {
  const t = await getTranslations("api");

  return Response.json({
    message: t("success"),
  });
}
```

## Locale Routing

### URL Structure

All pages include the locale prefix:

- English: `/en/courses`
- Spanish: `/es/courses`

### Navigation

Use the `Link` component with locale support:

```typescript
import { Link } from 'next-intl';

export default function Navigation() {
  return (
    <nav>
      <Link href="/courses">
        {t('navigation.courses')}
      </Link>
    </nav>
  );
}
```

### Programmatic Navigation

Use the `useRouter` hook for programmatic navigation:

```typescript
import { useRouter } from 'next-intl/client';

export default function LanguageSwitcher() {
  const router = useRouter();

  const switchLanguage = (locale: string) => {
    router.push('/', { locale });
  };

  return (
    <button onClick={() => switchLanguage('es')}>
      Español
    </button>
  );
}
```

## Language Switcher

### Component Implementation

The language switcher component (`web/src/components/LanguageSwitcher.tsx`):

```typescript
'use client';

import { useLocale, useTranslations } from 'next-intl';
import { useRouter } from 'next-intl/client';

export default function LanguageSwitcher() {
  const locale = useLocale();
  const router = useRouter();
  const t = useTranslations('common');

  const switchLanguage = (newLocale: string) => {
    router.replace(router.asPath, { locale: newLocale });
  };

  return (
    <div>
      <button
        onClick={() => switchLanguage('en')}
        className={locale === 'en' ? 'active' : ''}
      >
        English
      </button>
      <button
        onClick={() => switchLanguage('es')}
        className={locale === 'es' ? 'active' : ''}
      >
        Español
      </button>
    </div>
  );
}
```

### Accessibility

The language switcher includes proper accessibility features:

- ARIA labels for screen readers
- Keyboard navigation support
- Visual indicators for current language

## Adding a New Language

### 1. Update Locale Configuration

Add the new locale to `web/i18n/request.ts`:

```typescript
export const locales = ["en", "es", "fr"] as const;
```

### 2. Create Message Catalog

Create a new message file `web/messages/fr.json`:

```json
{
  "common": {
    "loading": "Chargement...",
    "error": "Une erreur s'est produite",
    "save": "Enregistrer",
    "cancel": "Annuler"
  },
  "auth": {
    "signIn": "Se connecter",
    "signUp": "S'inscrire",
    "email": "E-mail",
    "password": "Mot de passe"
  }
}
```

### 3. Update Type Definitions

Update `web/messages/index.ts` to include the new locale:

```typescript
import { getRequestConfig } from "next-intl/server";
import { locales } from "../i18n/request";

export default getRequestConfig(async ({ locale }) => {
  if (!locales.includes(locale as any)) {
    locale = "en";
  }

  return {
    messages: (await import(`./${locale}.json`)).default,
  };
});
```

### 4. Update Language Switcher

Add the new language option to the language switcher component.

### 5. Test the Implementation

Run the i18n tests to ensure the new language works correctly:

```bash
npm run test:e2e -- i18n-switcher.spec.ts
```

## Testing

### E2E Testing

The project includes comprehensive i18n testing in `web/tests/e2e/i18n-switcher.spec.ts`:

```typescript
import { test, expect } from "@playwright/test";

test.describe("Internationalization", () => {
  test("should switch between languages", async ({ page }) => {
    await page.goto("/en");
    await expect(page.locator("h1")).toContainText("Welcome");

    await page.click('[data-testid="language-switcher-es"]');
    await expect(page.locator("h1")).toContainText("Bienvenido");
  });
});
```

### Unit Testing

Test translation functions:

```typescript
import { render, screen } from '@testing-library/react';
import { NextIntlClientProvider } from 'next-intl';
import messages from '../messages/en.json';

test('renders translated content', () => {
  render(
    <NextIntlClientProvider messages={messages}>
      <CourseList />
    </NextIntlClientProvider>
  );

  expect(screen.getByText('Courses')).toBeInTheDocument();
});
```

## Best Practices

### Message Organization

1. **Group by feature**: Organize messages by feature or component
2. **Use descriptive keys**: Use clear, descriptive translation keys
3. **Avoid concatenation**: Don't concatenate strings, use interpolation instead
4. **Keep context**: Include context for translators

### Translation Keys

```json
{
  "courses": {
    "title": "Available Courses",
    "enrolled": "You are enrolled in {count} courses",
    "progress": "Progress: {percent}% complete"
  }
}
```

### Interpolation

Use interpolation for dynamic content:

```typescript
const t = useTranslations('courses');

// Good
<p>{t('enrolled', { count: 3 })}</p>

// Avoid
<p>{t('enrolled')} {count} {t('courses')}</p>
```

### Pluralization

Handle pluralization correctly:

```json
{
  "courses": {
    "enrolled": "You are enrolled in {count} course",
    "enrolled_plural": "You are enrolled in {count} courses"
  }
}
```

## Performance Considerations

### Message Loading

- Messages are loaded on-demand
- Only the current locale's messages are loaded
- Messages are cached for better performance

### Bundle Size

- Each locale adds to the bundle size
- Consider lazy loading for large message catalogs
- Use code splitting for locale-specific components

## Troubleshooting

### Common Issues

1. **Translation not found**:

   - Check if the translation key exists in the message catalog
   - Verify the locale is supported

2. **Locale not switching**:

   - Check middleware configuration
   - Verify the locale is in the supported locales list

3. **Type errors**:
   - Run `npm run typecheck` to check for type issues
   - Update message type definitions if needed

### Debugging

Enable i18n debugging:

```typescript
// In development
const t = useTranslations("common");
console.log("Translation key:", t.raw("loading"));
```

## Related Documentation

- [Architecture](./ARCHITECTURE.md) - System architecture overview
- [Testing Strategy](./testing/STRATEGY.md) - Testing internationalization
- [Accessibility](./ACCESSIBILITY.md) - Accessibility considerations for i18n
- [API Routes](./api/ROUTES.md) - API internationalization
